# Yarn Berry Migration - Next Steps

## âœ… Completed Changes

All configuration files have been updated for Yarn Berry v4 migration:

### Files Created
- âœ… `.yarnrc.yml` - Yarn Berry configuration
- âœ… `YARN_BERRY_MIGRATION_PLAN.md` - Detailed migration plan
- âœ… `MIGRATION_CHECKLIST.md` - Quick reference checklist

### Files Modified
- âœ… `.gitignore` - Added Yarn Berry cache exclusions
- âœ… `.dockerignore` - Added Yarn Berry cache exclusions
- âœ… `package.json` - Added `packageManager: "yarn@4.12.0"`
- âœ… `Dockerfile.ci` - Updated to use Corepack and Yarn v4
- âœ… `Dockerfile.ci.runner` - Updated to use Corepack and Yarn v4
- âœ… `.github/workflows/frontend-build.yml` - Updated to use `--immutable` flag
- âœ… `README.md` - Added Yarn Berry setup instructions

---

## ğŸ”„ Required Local Actions

The following steps **must be performed locally** to complete the migration:

### 1. Enable Corepack and Install Yarn Berry

```bash
# Enable Corepack (one-time setup)
corepack enable

# Verify Yarn version
yarn --version
# Should output: 4.12.0
```

### 2. Delete Old Yarn Lock File

```bash
# Remove the old Yarn Classic lock file
rm yarn.lock
```

### 3. Generate New Yarn Berry Lock File

```bash
# Install dependencies with Yarn Berry
yarn install

# This will create a new yarn.lock in Yarn Berry format
```

### 4. Verify Installation

```bash
# Check that node_modules was created
ls -la node_modules/

# Verify workspace packages are linked
ls -la packages/*/node_modules/
```

---

## ğŸ§ª Testing Checklist

After generating the new lock file, test all workflows:

### Build Scripts
```bash
# Test all build commands
yarn build          # ODF plugin
yarn build-mco      # MCO plugin
yarn build-client   # Client plugin
```

### Development Scripts
```bash
# Test development mode
yarn dev            # ODF plugin dev mode
yarn dev-mco        # MCO plugin dev mode
yarn dev-client     # Client plugin dev mode
```

### Code Quality
```bash
# Run linting
yarn lint

# Run formatting check
yarn format-test

# Run i18n check
yarn i18n-test
```

### Unit Tests
```bash
# Run all tests
yarn test

# Run with coverage
yarn test-coverage
```

### Bundle Analysis
```bash
# Analyze bundles
yarn analyze-odf
yarn analyze-mco
yarn analyze-client
```

---

## ğŸ³ Docker Testing

Test Docker builds to ensure Corepack works correctly:

```bash
# Build ODF plugin image
docker build -t odf-console:test -f Dockerfile.ci . --build-arg OPENSHIFT_CI=false

# Build MCO plugin image
docker build -t odf-mco-console:test -f Dockerfile.ci . --build-arg PLUGIN=mco --build-arg OPENSHIFT_CI=false

# Build Client plugin image
docker build -t odf-client-console:test -f Dockerfile.ci . --build-arg PLUGIN=client --build-arg OPENSHIFT_CI=false

# Build CI runner image
docker build -t odf-console-ci-runner:test -f Dockerfile.ci.runner .
```

---

## ğŸ” Verification Points

### 1. Lock File Format
The new `yarn.lock` should start with:
```yaml
# This file is generated by running "yarn install" inside your project.
# Manual changes might be lost - proceed with caution!

__metadata:
  version: 8
  cacheKey: 10c0
```

### 2. Node Modules Structure
- Should have `node_modules/` directory (not `.pnp.cjs`)
- Workspace packages should be properly linked

### 3. Yarn Commands
All existing yarn commands should work:
- `yarn install`
- `yarn build`
- `yarn test`
- `yarn lint`
- etc.

### 4. CI/CD Pipelines
- GitHub Actions should pass
- Docker builds should succeed
- OpenShift CI should work

---

## ğŸš¨ Troubleshooting

### Issue: "Corepack not found"
**Solution**: Update Node.js to 16.10+ or install Corepack separately:
```bash
npm install -g corepack
corepack enable
```

### Issue: "Invalid package manager"
**Solution**: Ensure `packageManager` field in `package.json` is correct:
```json
"packageManager": "yarn@4.12.0"
```

### Issue: "Cannot find module"
**Solution**: Clear cache and reinstall:
```bash
rm -rf node_modules .yarn/cache
yarn install
```

### Issue: "Workspace dependency not found"
**Solution**: Verify workspace configuration in `package.json`:
```json
"workspaces": [
  "packages/*"
]
```

---

## ğŸ“ Commit Strategy

### Option 1: Single Commit
Commit all changes together:
```bash
git add .
git commit -m "chore: migrate from Yarn Classic to Yarn Berry v4

- Add .yarnrc.yml configuration for Yarn Berry
- Update .gitignore and .dockerignore for Yarn cache
- Update Dockerfiles to use Corepack
- Update GitHub Actions workflows
- Update README with Yarn Berry instructions
- Regenerate yarn.lock with Yarn Berry format

Follows the same approach as OpenShift console PR #15986"
```

### Option 2: Multiple Commits
Break into logical commits:
1. Configuration files (`.yarnrc.yml`, `.gitignore`, `.dockerignore`)
2. Package.json and Docker updates
3. CI/CD workflow updates
4. Documentation updates
5. Lock file regeneration

---

## ğŸ¯ Success Criteria

Migration is complete when:
- âœ… New `yarn.lock` is generated in Yarn Berry format
- âœ… All build scripts pass (`yarn build`, `yarn build-mco`, `yarn build-client`)
- âœ… All tests pass (`yarn test`)
- âœ… All linting passes (`yarn lint`, `yarn format-test`, `yarn i18n-test`)
- âœ… Docker images build successfully
- âœ… GitHub Actions workflows pass
- âœ… Development mode works (`yarn dev`)

---

## ğŸ“š Additional Resources

- [Yarn Berry Documentation](https://yarnpkg.com/)
- [Yarn Berry Migration Guide](https://yarnpkg.com/getting-started/migration)
- [Corepack Documentation](https://nodejs.org/api/corepack.html)
- [OpenShift Console PR #15986](https://github.com/openshift/console/pull/15986)

---

## ğŸ¤ Getting Help

If you encounter issues:
1. Check the troubleshooting section above
2. Review the detailed migration plan in `YARN_BERRY_MIGRATION_PLAN.md`
3. Compare with OpenShift console PR #15986
4. Check Yarn Berry documentation

---

**Last Updated**: 2026-02-25  
**Migration Status**: Configuration Complete - Awaiting Local Execution
